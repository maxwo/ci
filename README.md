# Continuous Integration scripts

Simple shell scripts to perform Continuous Integration tasks, mostly with Travis CI.

## Installation

Simply get the latest CI release thanks to an `after_success` clause in your `.travis.yml`:

```yaml
after_success:
  - wget https://github.com/maxwo/ci/releases/download/0.1.0/ci-0.1.0-sources.tar.gz -O - | tar -xz
```

## Deploy to Docker Hub

Build docker images, tag, and deploy them to Docker Hub.

This script assumes your Docker Hub ID is the same as your Github ID. Hence, maxwo/healthcheck Github repository
will be deployed as maxwo/healthcheck:latest for instance.

The script uses a DOCKER_PASSWORD environment variable to perform Docker Hub login.

If the build is triggered by a push on the repository, then an image will be deploy with a tag corresponding to the
current branch. For instance, if a push is performed on a `feature/authentication`, then an image tagged
`feature-authentication` will be pushed. Pushes on master branch are also tagged as `latest`.

If the build is triggered by a git tag, then an image tagged with the corresponding tag will be created.

To use this script to push both git tags and git pushes on Docker Hub, add the following `after_success`
clause to your `.travis.yml`:

```yaml
after_success:
  - wget https://github.com/maxwo/ci/releases/download/0.1.0/ci-0.1.0-sources.tar.gz -O - | tar -xz
  - ci/travis/docker_deploy.sh
```

To restraint Hub pushed to only tags or git pushes, consider using the `script` provider:

```yaml
after_success:
  - wget https://github.com/maxwo/ci/releases/download/0.1.0/ci-0.1.0-sources.tar.gz -O - | tar -xz

deploy:
  - provider: script
    skip_cleanup: true
    script: ci/travis/docker_deploy.sh
    on:
      tags: true
```

## Codacy Java test coverage

Deploy Java test coverage compiled with JaCoCo to Codacy.

This script assumes a CODACY_PROJECT_TOKEN environment variable contains the project token generated by Codacy.

You first need to declare JaCoCo and activate its agent during `mvn test` command thanks to your `pom.xml`:

```xml
<build>
	<plugins>
		<plugin>
			<groupId>org.jacoco</groupId>
			<artifactId>jacoco-maven-plugin</artifactId>
			<version>0.7.9</version>
			<executions>
				<execution>
					<goals>
						<goal>prepare-agent</goal>
					</goals>
				</execution>
				<execution>
					<id>report</id>
					<phase>test</phase>
					<goals>
						<goal>report</goal>
					</goals>
				</execution>
			</executions>
		</plugin>
</build>
```

Then, as usual, in your `.travis.yml`, add an `after_success` clause:

```yaml
after_success:
  - wget https://github.com/maxwo/ci/releases/download/0.1.0/ci-0.1.0-sources.tar.gz -O - | tar -xz
  - ci/travis/codacy_java_coverage.sh
```

## Coveralls Java test coverage

Deploy Java test coverage to Coveralls.

This script assumes a COVERALLS_PROJECT_TOKEN environment variable contains the token generated by Coveralls.

To use this script, just drop the following lines in the `.travis.yml`:

```yaml
after_success:
  - wget https://github.com/maxwo/ci/releases/download/0.1.0/ci-0.1.0-sources.tar.gz -O - | tar -xz
  - ci/travis/coveralls_java_coverage.sh
```

## Sources archive generation

Generate a tarball containing the sources of the project, useful for releases.

This script ignores hidden files, and the tarball name is equal to the repository name.

To use it, just drop these lines in the `.travis.yml` file, and the sources archives will be deployed as part of 
your release:

```yaml
after_success:
  - ci/travis/package_sources.sh

deploy:
  provider: releases
  skip_cleanup: true
  api_key:
    secure: XXXXXXXXXXX
  file: myproject-$TRAVIS_TAG-sources.tar.gz
  on:
    tags: true
```
